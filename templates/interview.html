<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Interview Prep - Smart Job Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .q-card {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .q-type {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--secondary-color);
            margin-bottom: 5px;
            display: block;
            font-weight: 700;
        }

        .q-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .answer-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border-left: 3px solid var(--accent-color);
        }

        .show-ans-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .show-ans-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div class="bg-shape one"></div>
    <div class="bg-shape two"></div>

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round">
                <div class="icon sun">‚òÄÔ∏è</div>
                <div class="icon moon">üåô</div>
            </div>
        </label>
    </div>

    <div class="container">
        <header>
            <div class="logo">SmartJob<span>AI</span></div>
            <p>Mock Interview Prep</p>
            <div class="menu-icon" onclick="window.location.href='/'">üè†</div>
        </header>

        <main id="app">
            <div class="glass-card full-width">
                <div class="dashboard-header">
                    <h2>Ace Your Interview</h2>
                    <button class="btn-text" onclick="window.location.href='/'">‚Üê Back to Home</button>
                </div>
                <p class="subtitle">Upload your resume to get questions tailored specifically to your projects and
                    skills.</p>

                <form id="interview-form">
                    <div class="drop-zone" id="drop-zone" style="margin-bottom: 20px;">
                        <p>Drag & Drop your resume here</p>
                        <p class="small">or</p>
                        <button type="button" class="btn-outline"
                            onclick="document.getElementById('file-input').click()">Browse Files</button>
                        <input type="file" id="file-input" name="resume" accept=".pdf,.docx" hidden>
                    </div>
                    <div id="file-name" class="hidden" style="margin-bottom: 10px; color: var(--accent-glow);"></div>
                    <button type="submit" class="btn-primary" id="generate-btn" style="width: 100%;" disabled>Generate
                        Questions</button>
                </form>

                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>AI is analyzing your resume to create questions...</p>
                </div>

                <div id="results" class="enhance-output hidden" style="margin-top: 30px;">
                    <!-- Questions go here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const form = document.getElementById('interview-form');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const fileName = document.getElementById('file-name');
        const generateBtn = document.getElementById('generate-btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        // Add Export Button (created dynamically)
        const exportBtn = document.createElement('button');
        exportBtn.className = 'btn-outline hidden';
        exportBtn.textContent = 'üìÑ Export PDF';
        exportBtn.id = 'export-pdf-btn';
        exportBtn.style.padding = '8px 15px';
        exportBtn.style.fontSize = '0.9rem';
        exportBtn.style.marginBottom = '20px';
        exportBtn.style.float = 'right'; // Float right to align

        // Insert Export Button before results
        // We'll insert it into a container or directly before results
        results.parentNode.insertBefore(exportBtn, results);

        // Clear float after
        const clearDiv = document.createElement('div');
        clearDiv.style.clear = 'both';
        results.parentNode.insertBefore(clearDiv, results);

        // Export Logic
        exportBtn.addEventListener('click', () => {
            // Create a printable container
            const element = document.createElement('div');
            element.innerHTML = results.innerHTML;

            // Styling for the PDF container to ensure top alignment
            element.style.padding = '40px';
            element.style.background = '#ffffff';
            element.style.width = '100%';
            element.style.boxSizing = 'border-box';
            element.style.color = '#000000';
            element.style.position = 'relative'; // Ensure context
            element.style.margin = '0';

            // Clean up for PDF
            const buttons = element.querySelectorAll('button');
            buttons.forEach(btn => btn.remove());

            const answers = element.querySelectorAll('.answer-box');
            answers.forEach(ans => {
                ans.style.display = 'block';
                ans.style.background = '#f9f9f9';
                ans.style.color = '#333';
                ans.style.border = '1px solid #ddd';
                ans.style.padding = '15px';
                ans.style.marginTop = '15px';
                ans.style.textAlign = 'left';
                ans.style.boxShadow = 'none';
            });

            const cards = element.querySelectorAll('.q-card');
            cards.forEach(card => {
                card.style.background = '#fff';
                card.style.color = '#000';
                card.style.border = 'none';
                card.style.borderBottom = '1px solid #eee';
                card.style.marginBottom = '20px';
                card.style.padding = '10px 0';
                card.style.textAlign = 'left';
                card.style.boxShadow = 'none';
                card.style.pageBreakInside = 'avoid';
            });

            const qTypes = element.querySelectorAll('.q-type');
            qTypes.forEach(qt => {
                qt.style.color = '#4f46e5';
                qt.style.fontSize = '0.9rem';
                qt.style.marginBottom = '5px';
            });

            const qTexts = element.querySelectorAll('.q-text');
            qTexts.forEach(qt => {
                qt.style.fontSize = '1.2rem';
                qt.style.marginBottom = '10px';
                qt.style.color = '#111';
            });

            // Add Title
            const title = document.createElement('h1');
            title.textContent = "Mock Interview Details";
            title.style.textAlign = 'center';
            title.style.marginBottom = '40px';
            title.style.fontFamily = 'Helvetica, sans-serif';
            title.style.color = '#111';
            title.style.borderBottom = '2px solid #4f46e5';
            title.style.paddingBottom = '10px';
            element.insertBefore(title, element.firstChild);

            const opt = {
                margin: 0.3, // inches
                filename: 'Mock_Interview_Questions.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, scrollY: 0, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        });

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFile();
            }
        });

        fileInput.addEventListener('change', handleFile);

        function handleFile() {
            if (fileInput.files.length) {
                fileName.textContent = `Selected: ${fileInput.files[0].name}`;
                fileName.classList.remove('hidden');
                generateBtn.disabled = false;
            }
        }

        // Theme Logic
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.body.classList.add(currentTheme);
            if (currentTheme === 'light-mode') toggleSwitch.checked = true;
        }
        toggleSwitch.addEventListener('change', function (e) {
            if (e.target.checked) {
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light-mode');
            } else {
                document.body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark-mode');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('resume', fileInput.files[0]);

            loading.classList.remove('hidden');
            results.classList.add('hidden');
            exportBtn.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const res = await fetch('/generate-interview', {
                    method: 'POST',
                    body: formData // Send as FormData for file upload
                });
                const data = await res.json();

                results.innerHTML = '';
                if (data.questions) {
                    data.questions.forEach((q, index) => {
                        const div = document.createElement('div');
                        div.className = 'q-card';
                        div.innerHTML = `
                            <span class="q-type">${q.type} Question</span>
                            <div class="q-text">${q.question}</div>
                            <button class="show-ans-btn" onclick="toggleAnswer('ans-${index}')">‚¨á Show Answer</button>
                            <div id="ans-${index}" class="answer-box">
                                <strong>Suggested Answer:</strong><br>${q.answer}
                            </div>
                        `;
                        results.appendChild(div);
                    });
                    results.classList.remove('hidden');
                    exportBtn.classList.remove('hidden'); // Show export button
                } else if (data.error) {
                    alert(data.error);
                }
            } catch (e) {
                alert("Error generating questions");
                console.error(e);
            } finally {
                loading.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });

        window.toggleAnswer = function (id) {
            const el = document.getElementById(id);
            if (el.style.display === 'block') el.style.display = 'none';
            else el.style.display = 'block';
        }
    </script>
</body>

</html>